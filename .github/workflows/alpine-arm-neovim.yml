name: Build Neovim Offline ARM

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04-arm
    container: alpine:edge

    steps:
      - name: ðŸ”§ Install tools
        run: apk add curl tar bash git

      - name: ðŸ“¦ Build Neovim Package
        run: |
          ARCH=aarch64
          echo "https://dl-cdn.alpinelinux.org/alpine/edge/main" > /etc/apk/repositories
          echo "https://dl-cdn.alpinelinux.org/alpine/edge/community" >> /etc/apk/repositories
          apk update
          apk fetch --recursive --output neovim-$ARCH neovim

          NEOVIM_APK=$(ls neovim-$ARCH/neovim-*.apk | head -n 1)
          VERSION=$(basename "$NEOVIM_APK" | sed -E 's/neovim-([0-9]+\.[0-9]+\.[0-9]+)-r[0-9]+\.apk/\1/')
          TAR="neovim-${VERSION}-${ARCH}.tar.gz"
          tar czf "$TAR" neovim-$ARCH

          mkdir -p /tmp/output
          mv "$TAR" /tmp/output/

      # âœ… JS Action ç§»å‡ºå®¹å™¨ï¼Œç”¨ artifact å‘½ä»¤ä»Ž `/tmp/output/` ä¼ ç»™ä¸‹ä¸€é˜¶æ®µ
      - name: âœ… Save build artifact
        shell: sh
        run: |
          echo "::group::Move artifact"
          cp /tmp/output/*.tar.gz .
          echo "::endgroup::"

  upload:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: ðŸ§¾ Download artifact from previous job
        uses: actions/download-artifact@v4
        with:
          name: artifact
          path: .

      - name: ðŸš€ Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v0.11.1"
          name: "Neovim Offline Package ARM"
          files: neovim-*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
