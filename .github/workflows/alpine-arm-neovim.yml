name: Build Neovim ARM Only

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  fetch:
    runs-on: ubuntu-24.04-arm
    container: alpine:edge
    outputs:
      version: ${{ steps.fetch_neovim.outputs.version }}
      package_name: ${{ steps.fetch_neovim.outputs.package_name }}
    steps:
      - name: üîß Install Tools
        run: apk add curl tar bash git

      - name: üì¶ Fetch Neovim APKs
        id: fetch_neovim
        run: |
          APK_ARCH=aarch64
          PKGDIR="neovim-${APK_ARCH}"
          mkdir -p "$PKGDIR"

          echo "https://dl-cdn.alpinelinux.org/alpine/edge/main" > /etc/apk/repositories
          echo "https://dl-cdn.alpinelinux.org/alpine/edge/community" >> /etc/apk/repositories
          apk update
          apk fetch --recursive --output "$PKGDIR" neovim

          NEOVIM_APK=$(ls "$PKGDIR"/neovim-*.apk | head -n 1)
          VERSION=$(basename "$NEOVIM_APK" | sed -E 's/neovim-([0-9]+\.[0-9]+\.[0-9]+)-r[0-9]+\.apk/\1/')
          OUTPUT="neovim-${VERSION}-${APK_ARCH}.tar.gz"
          tar czf "$OUTPUT" "$PKGDIR"

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "package_name=$OUTPUT" >> "$GITHUB_OUTPUT"

      - name: üì¶ Upload artifact for next job
        uses: actions/upload-artifact@v4
        with:
          name: neovim-arm-tar
          path: neovim-*.tar.gz

  release:
    runs-on: ubuntu-latest
    needs: fetch
    steps:
      - name: ‚¨áÔ∏è Download artifact
        uses: actions/download-artifact@v4
        with:
          name: neovim-arm-tar

      - name: üöÄ Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ needs.fetch.outputs.version }}"
          name: "Neovim Offline ARM v${{ needs.fetch.outputs.version }}"
          files: neovim-*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
