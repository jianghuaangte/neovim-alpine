name: Build Neovim Offline Package (Fetch Only, No Install)

on:
  workflow_dispatch:   # æ‰‹åŠ¨è§¦å‘
  push:
    tags:
      - "v*"           # ä¾ç„¶æ”¯æŒæ‰‹åŠ¨æŽ¨é€ tag è§¦å‘ï¼ˆå¤‡ç”¨ï¼‰

jobs:
  build:
    runs-on: ubuntu-latest
    container: alpine:edge

    steps:
      - name: ðŸ“‚ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Install Tools
        run: |
          apk update
          apk add curl tar git bash

      - name: ðŸ“¦ Fetch Neovim APKs Only (No Install)
        id: fetch_neovim
        run: |
          # èŽ·å–æž¶æž„ä¿¡æ¯ï¼Œç»Ÿä¸€æ˜ å°„ä¸º apk æ”¯æŒçš„æž¶æž„å
          ARCH=$(uname -m)
          if [ "$ARCH" = "x86_64" ]; then
            APK_ARCH="x86_64"
          elif [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then
            APK_ARCH="aarch64"
          else
            echo "Unsupported architecture: $ARCH"
            exit 1
          fi

          PKGDIR="neovim-${APK_ARCH}"
          mkdir -p "$PKGDIR"

          # é…ç½® edge ä»“åº“
          echo "https://dl-cdn.alpinelinux.org/alpine/edge/main" > /etc/apk/repositories
          echo "https://dl-cdn.alpinelinux.org/alpine/edge/community" >> /etc/apk/repositories
          apk update

          # ä¸‹è½½ neovim åŠæ‰€æœ‰ä¾èµ– .apk æ–‡ä»¶ï¼Œä»…ä¸‹è½½
          apk fetch --recursive --output "$PKGDIR" neovim

          # ä»Žä¸‹è½½çš„ apk ä¸­è§£æž neovim ç‰ˆæœ¬å·ï¼ˆç¤ºä¾‹ç”¨ basename åŽ»æŽ‰ç‰ˆæœ¬èŽ·å–ï¼‰
          NEOVIM_APK=$(ls "$PKGDIR"/neovim-*.apk | head -n 1)
          if [ -z "$NEOVIM_APK" ]; then
            echo "Neovim APK not found!"
            exit 1
          fi

          # ç‰ˆæœ¬å·ä¸€èˆ¬æ ¼å¼ï¼šneovim-0.9.1-r0.apkï¼Œæå– 0.9.1
          VERSION=$(basename "$NEOVIM_APK" | sed -E 's/neovim-([0-9]+\.[0-9]+\.[0-9]+)-r[0-9]+\.apk/\1/')

          OUTPUT="neovim-${VERSION}-${APK_ARCH}.tar.gz"
          tar czf "$OUTPUT" "$PKGDIR"

          echo "PACKAGE_NAME=$OUTPUT" >> "$GITHUB_ENV"
          echo "NEOVIM_VERSION=$VERSION" >> "$GITHUB_ENV"
          echo "ARCH=$APK_ARCH" >> "$GITHUB_ENV"

      - name: ðŸš€ Create Release and Upload Package
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ env.NEOVIM_VERSION }}-${{ env.ARCH }}"
          name: "Neovim Offline Package v${{ env.NEOVIM_VERSION }} (${ { env.ARCH } })"
          files: ${{ env.PACKAGE_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
